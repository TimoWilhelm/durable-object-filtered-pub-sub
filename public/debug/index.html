<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Durable Objects Pub-Sub Debug Dashboard</title>
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				margin: 0;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.dashboard {
				max-width: 1400px;
				margin: 0 auto;
			}
			.header {
				background: #2563eb;
				color: white;
				padding: 20px;
				border-radius: 8px;
				margin-bottom: 20px;
			}
			.grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
				gap: 20px;
				margin-bottom: 20px;
			}
			.card {
				background: white;
				border-radius: 8px;
				padding: 20px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.card h3 {
				margin-top: 0;
				color: #1f2937;
				border-bottom: 2px solid #e5e7eb;
				padding-bottom: 10px;
			}
			.stats {
				display: flex;
				justify-content: space-between;
				margin-bottom: 10px;
			}
			.stat-value {
				font-weight: bold;
				font-size: 1.2em;
				color: #059669;
			}
			.interaction {
				padding: 8px;
				margin: 5px 0;
				border-left: 4px solid #3b82f6;
				background: #f8fafc;
				font-size: 0.9em;
			}
			.interaction.error {
				border-left-color: #ef4444;
				background: #fef2f2;
			}
			.component {
				padding: 10px;
				margin: 5px 0;
				border-radius: 6px;
				background: #f0f9ff;
				border: 1px solid #0ea5e9;
			}
			.component.inactive {
				background: #f3f4f6;
				border-color: #6b7280;
				opacity: 0.7;
			}
			.refresh-btn {
				background: #059669;
				color: white;
				border: none;
				padding: 8px 16px;
				border-radius: 4px;
				cursor: pointer;
				margin: 10px 5px 10px 0;
			}
			.refresh-btn:hover {
				background: #047857;
			}
			.timeline {
				max-height: 400px;
				overflow-y: auto;
			}
			.loading {
				color: #6b7280;
				font-style: italic;
			}
			.flow-diagram {
				background: white;
				border-radius: 8px;
				padding: 20px;
				margin-bottom: 20px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				overflow-x: auto;
			}
			.flow-svg {
				width: 100%;
				height: 500px;
				border: 1px solid #e5e7eb;
				border-radius: 6px;
			}
			.component-node {
				fill: #dbeafe;
				stroke: #3b82f6;
				stroke-width: 2;
				cursor: pointer;
			}
			.component-node.active {
				fill: #bfdbfe;
				stroke: #1d4ed8;
				stroke-width: 3;
			}
			.component-node.error {
				fill: #fecaca;
				stroke: #dc2626;
			}
			.flow-connection {
				stroke: #6b7280;
				stroke-width: 2;
				fill: none;
				marker-end: url(#arrowhead);
			}
			.flow-connection.active {
				stroke: #059669;
				stroke-width: 3;
				animation: flow-pulse 2s infinite;
			}
			.component-text {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				font-size: 12px;
				fill: #374151;
				text-anchor: middle;
				dominant-baseline: middle;
			}
			.component-label {
				font-weight: bold;
				font-size: 13px;
			}
			.component-stats {
				font-size: 10px;
				fill: #6b7280;
			}
			@keyframes flow-pulse {
				0% {
					stroke-opacity: 0.5;
				}
				50% {
					stroke-opacity: 1;
				}
				100% {
					stroke-opacity: 0.5;
				}
			}
			.flow-legend {
				display: flex;
				gap: 20px;
				margin-top: 10px;
				flex-wrap: wrap;
			}
			.legend-item {
				display: flex;
				align-items: center;
				gap: 5px;
				font-size: 12px;
			}
			.legend-circle {
				width: 12px;
				height: 12px;
				border-radius: 50%;
				border: 2px solid;
			}
		</style>
	</head>
	<body>
		<div class="dashboard">
			<div class="header">
				<h1>üîß Durable Objects Pub-Sub Debug Dashboard</h1>
				<p>Real-time monitoring of Publisher ‚Üí Distributor ‚Üí Subscriber interactions</p>
			</div>

			<div class="flow-diagram">
				<h3>üîÑ System Flow Diagram</h3>
				<button class="refresh-btn" onclick="refreshFlowDiagram()">Refresh Flow</button>
				<button class="refresh-btn" onclick="generateTickerData()" style="background: #7c3aed">Generate Data</button>
				<span id="refresh-status" style="margin-left: 10px; font-size: 12px; color: #6b7280"></span>
				<svg class="flow-svg" id="flow-svg">
					<defs>
						<marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
							<polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" />
						</marker>
						<marker id="arrowhead-active" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
							<polygon points="0 0, 10 3.5, 0 7" fill="#059669" />
						</marker>
					</defs>
				</svg>
				<div class="flow-legend">
					<div class="legend-item">
						<div class="legend-circle" style="background: #dbeafe; border-color: #3b82f6"></div>
						<span>Active Component</span>
					</div>
					<div class="legend-item">
						<div class="legend-circle" style="background: #bfdbfe; border-color: #1d4ed8"></div>
						<span>High Activity</span>
					</div>
					<div class="legend-item">
						<div class="legend-circle" style="background: #fecaca; border-color: #dc2626"></div>
						<span>Has Errors</span>
					</div>
					<div class="legend-item">
						<div style="width: 20px; height: 2px; background: #059669"></div>
						<span>Active Flow</span>
					</div>
				</div>
			</div>

			<div class="grid">
				<div class="card">
					<h3>üìä System Overview</h3>
					<button class="refresh-btn" onclick="refreshOverview()">Refresh</button>
					<div id="overview">Loading...</div>
				</div>

				<div class="card">
					<h3>‚ö° Recent Interactions</h3>
					<button class="refresh-btn" onclick="refreshInteractions()">Refresh</button>
					<input type="number" id="interaction-limit" placeholder="Limit" value="20" style="width: 80px; margin: 0 10px" />
					<div class="timeline" id="interactions">Loading...</div>
				</div>

				<div class="card">
					<h3>üèóÔ∏è Active Components</h3>
					<button class="refresh-btn" onclick="refreshComponents()">Refresh</button>
					<div id="components">Loading...</div>
				</div>

				<div class="card">
					<h3>üìà Message Flow Timeline</h3>
					<button class="refresh-btn" onclick="refreshTimeline()">Refresh</button>
					<select id="timeline-minutes">
						<option value="1">Last 1 minute</option>
						<option value="5" selected>Last 5 minutes</option>
						<option value="15">Last 15 minutes</option>
					</select>
					<div class="timeline" id="timeline">Loading...</div>
				</div>
			</div>
		</div>

		<script>
			// Auto-refresh every 5 seconds
			setInterval(() => {
				refreshOverview();
				refreshInteractions();
				refreshComponents();
				refreshFlowDiagram();
			}, 5000);

			// Initial load
			window.addEventListener('DOMContentLoaded', () => {
				refreshOverview();
				refreshInteractions();
				refreshComponents();
				refreshTimeline();
				refreshFlowDiagram();
			});

			async function refreshOverview() {
				try {
					const response = await fetch('/debug/overview');
					const data = await response.json();
					document.getElementById('overview').innerHTML = `
					<div class="stats">
						<span>Total Messages (5m):</span>
						<span class="stat-value">${data.totalMessages}</span>
					</div>
					<div class="stats">
						<span>Active Publishers:</span>
						<span class="stat-value">${data.activePublishers}</span>
					</div>
					<div class="stats">
						<span>Active Distributors:</span>
						<span class="stat-value">${data.activeDistributors}</span>
					</div>
					<div class="stats">
						<span>Active Subscribers:</span>
						<span class="stat-value">${data.activeSubscribers}</span>
					</div>
					<h4>Message Flow:</h4>
					${data.messageFlow
						.map(
							(flow) => `
						<div class="stats">
							<span>${flow.operation}:</span>
							<span>${flow.count} (${flow.successRate.toFixed(1)}% success)</span>
						</div>
					`
						)
						.join('')}
				`;
				} catch (error) {
					document.getElementById('overview').innerHTML = '<div class="loading">Error loading overview</div>';
				}
			}

			async function refreshInteractions() {
				try {
					const limit = document.getElementById('interaction-limit').value || 20;
					const response = await fetch(`/debug/interactions?limit=${limit}`);
					const data = await response.json();
					document.getElementById('interactions').innerHTML = data
						.map(
							(interaction) => `
					<div class="interaction ${!interaction.success ? 'error' : ''}">
						<strong>${interaction.operation}</strong> 
						${interaction.sourceComponent}(${interaction.sourceId.slice(-8)}) ‚Üí 
						${interaction.targetComponent}(${interaction.targetId.slice(-8)})
						<br>
						<small>${new Date(interaction.timestamp).toLocaleTimeString()} 
						${interaction.duration ? `(${interaction.duration}ms)` : ''}
						${!interaction.success ? ` - ERROR: ${interaction.error}` : ''}</small>
					</div>
				`
						)
						.join('');
				} catch (error) {
					document.getElementById('interactions').innerHTML = '<div class="loading">Error loading interactions</div>';
				}
			}

			async function refreshComponents() {
				try {
					const response = await fetch('/debug/stats');
					const data = await response.json();
					document.getElementById('components').innerHTML = data
						.map(
							(comp) => `
					<div class="component ${!comp.isAlive ? 'inactive' : ''}">
						<strong>${comp.componentType}:</strong> ${comp.componentId.slice(-12)}
						<br>
						<small>
							Sent: ${comp.messagesSent}, Received: ${comp.messagesReceived}, 
							Errors: ${comp.errors}, Avg: ${comp.averageProcessingTime.toFixed(1)}ms
							<br>Last: ${new Date(comp.lastActivity).toLocaleTimeString()}
						</small>
					</div>
				`
						)
						.join('');
				} catch (error) {
					document.getElementById('components').innerHTML = '<div class="loading">Error loading components</div>';
				}
			}

			async function refreshTimeline() {
				try {
					const minutes = document.getElementById('timeline-minutes').value;
					const response = await fetch(`/debug/timeline?minutes=${minutes}`);
					const data = await response.json();
					document.getElementById('timeline').innerHTML = data
						.map(
							(timePoint) => `
					<div style="margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px;">
						<strong>${new Date(timePoint.timestamp).toLocaleTimeString()}</strong> 
						(${timePoint.interactions.length} interactions)
						${timePoint.interactions
							.slice(0, 3)
							.map(
								(i) => `
							<div style="margin: 5px 0; font-size: 0.9em; color: #6b7280;">
								${i.operation}: ${i.sourceComponent} ‚Üí ${i.targetComponent}
							</div>
						`
							)
							.join('')}
						${
							timePoint.interactions.length > 3
								? `<div style="font-size: 0.8em; color: #9ca3af;">... ${timePoint.interactions.length - 3} more</div>`
								: ''
						}
					</div>
				`
						)
						.join('');
				} catch (error) {
					document.getElementById('timeline').innerHTML = '<div class="loading">Error loading timeline</div>';
				}
			}

			async function refreshFlowDiagram() {
				console.log('Refreshing flow diagram...');
				const statusEl = document.getElementById('refresh-status');
				statusEl.textContent = 'üîÑ Refreshing...';
				statusEl.style.color = '#3b82f6';

				try {
					const [statsResponse, interactionsResponse] = await Promise.all([fetch('/debug/stats'), fetch('/debug/interactions?limit=50')]);

					console.log('API responses:', {
						statsStatus: statsResponse.status,
						interactionsStatus: interactionsResponse.status,
					});

					if (!statsResponse.ok || !interactionsResponse.ok) {
						throw new Error(`Failed to fetch debug data - Stats: ${statsResponse.status}, Interactions: ${interactionsResponse.status}`);
					}

					const stats = await statsResponse.json();
					const interactions = await interactionsResponse.json();

					console.log('Received data:', {
						statsCount: stats ? stats.length : 0,
						interactionsCount: interactions ? interactions.length : 0,
						stats: stats,
						interactions: interactions,
					});

					renderFlowDiagram(stats, interactions);

					statusEl.textContent = `‚úÖ Updated (${stats ? stats.length : 0} components)`;
					statusEl.style.color = '#059669';
					setTimeout(() => {
						statusEl.textContent = '';
					}, 3000);
				} catch (error) {
					console.error('Error loading flow diagram:', error);

					statusEl.textContent = `‚ùå Error: ${error.message}`;
					statusEl.style.color = '#dc2626';

					// Show error state in the diagram
					const svg = document.getElementById('flow-svg');
					while (svg.children.length > 1) {
						// Keep defs
						svg.removeChild(svg.lastChild);
					}

					const errorText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
					errorText.setAttribute('x', 600);
					errorText.setAttribute('y', 250);
					errorText.setAttribute('class', 'component-text component-label');
					errorText.setAttribute('text-anchor', 'middle');
					errorText.setAttribute('fill', '#dc2626');
					errorText.textContent = `‚ùå Error: ${error.message}`;
					svg.appendChild(errorText);
				}
			}

			function renderFlowDiagram(stats, interactions) {
				console.log('Rendering flow diagram with data:', { stats, interactions });
				const svg = document.getElementById('flow-svg');
				const svgWidth = 1200;
				const svgHeight = 500;

				if (!svg) {
					console.error('SVG element not found!');
					return;
				}

				// Clear existing content
				while (svg.children.length > 1) {
					// Keep defs
					svg.removeChild(svg.lastChild);
				}

				// Check if we have any data
				if (!stats || stats.length === 0) {
					// Show empty state message
					const emptyText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
					emptyText.setAttribute('x', svgWidth / 2);
					emptyText.setAttribute('y', svgHeight / 2 - 40);
					emptyText.setAttribute('class', 'component-text component-label');
					emptyText.setAttribute('text-anchor', 'middle');
					emptyText.textContent = 'üöÄ No system activity detected yet';
					svg.appendChild(emptyText);

					const instructionText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
					instructionText.setAttribute('x', svgWidth / 2);
					instructionText.setAttribute('y', svgHeight / 2);
					instructionText.setAttribute('class', 'component-text');
					instructionText.setAttribute('text-anchor', 'middle');
					instructionText.textContent = 'Generate some ticker data to see the flow diagram';
					svg.appendChild(instructionText);

					const kickstartText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
					kickstartText.setAttribute('x', svgWidth / 2);
					kickstartText.setAttribute('y', svgHeight / 2 + 20);
					kickstartText.setAttribute('class', 'component-text');
					kickstartText.setAttribute('text-anchor', 'middle');
					kickstartText.setAttribute('fill', '#0ea5e9');
					kickstartText.setAttribute('cursor', 'pointer');
					kickstartText.textContent = 'üëÜ Click here to generate ticker data';
					kickstartText.onclick = generateTickerData;
					svg.appendChild(kickstartText);
					return;
				}

				// Group components by type (debug log to see actual types)
				console.log('Component types found:', [...new Set(stats.map((c) => c.componentType))]);

				const componentTypes = {
					queue: stats.filter((c) => c.componentType.toLowerCase() === 'queue'),
					publisher: stats.filter((c) => c.componentType.toLowerCase() === 'publisher'),
					distributor: stats.filter((c) => c.componentType.toLowerCase() === 'distributor'),
					subscriber: stats.filter((c) => c.componentType.toLowerCase() === 'subscriber'),
				};

				console.log('Grouped components:', {
					queue: componentTypes.queue.length,
					publisher: componentTypes.publisher.length,
					distributor: componentTypes.distributor.length,
					subscriber: componentTypes.subscriber.length,
				});

				// Recent interactions for activity detection
				const recentInteractions = interactions.filter(
					(i) => Date.now() - new Date(i.timestamp).getTime() < 30000 // Last 30 seconds
				);

				// Layout configuration
				const layout = {
					queue: { x: 100, y: 250, width: 120, height: 60 },
					publisher: { x: 300, y: 150, width: 120, height: 60 },
					distributor: { x: 550, y: 250, width: 120, height: 60 },
					subscriber: { x: 800, y: 150, width: 120, height: 60 },
				};

				// Helper function to get component status
				function getComponentStatus(component, recentInteractions) {
					const hasErrors = component.errors > 0;
					const isActive = recentInteractions.some((i) => i.sourceId === component.componentId || i.targetId === component.componentId);
					const isHighActivity = component.messagesSent + component.messagesReceived > 10;

					if (hasErrors) return 'error';
					if (isHighActivity) return 'active';
					if (isActive) return 'normal';
					return 'inactive';
				}

				// Helper function to check if there's active flow between component types
				function hasActiveFlow(sourceType, targetType) {
					return recentInteractions.some((i) => {
						const sourceComp = stats.find((c) => c.componentId === i.sourceId);
						const targetComp = stats.find((c) => c.componentId === i.targetId);
						return sourceComp?.componentType === sourceType && targetComp?.componentType === targetType;
					});
				}

				// Check if we have any components in our filtered groups
				const totalGroupedComponents = Object.values(componentTypes).reduce((sum, comps) => sum + comps.length, 0);
				console.log('Total grouped components:', totalGroupedComponents, 'of', stats.length);

				// If no components match our expected types, show a fallback view
				if (totalGroupedComponents === 0) {
					const fallbackText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
					fallbackText.setAttribute('x', svgWidth / 2);
					fallbackText.setAttribute('y', svgHeight / 2 - 20);
					fallbackText.setAttribute('class', 'component-text component-label');
					fallbackText.setAttribute('text-anchor', 'middle');
					fallbackText.textContent = `Found ${stats.length} components but with unexpected types`;
					svg.appendChild(fallbackText);

					const typesList = document.createElementNS('http://www.w3.org/2000/svg', 'text');
					typesList.setAttribute('x', svgWidth / 2);
					typesList.setAttribute('y', svgHeight / 2 + 10);
					typesList.setAttribute('class', 'component-text');
					typesList.setAttribute('text-anchor', 'middle');
					typesList.textContent = `Types: ${[...new Set(stats.map((c) => c.componentType))].join(', ')}`;
					svg.appendChild(typesList);
					return;
				}

				// Render component groups
				Object.entries(componentTypes).forEach(([type, components]) => {
					if (components.length === 0) return;

					const typeLayout = layout[type];
					const componentCount = Math.min(components.length, 5); // Show max 5 components

					// Draw component group background
					const groupRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
					groupRect.setAttribute('x', typeLayout.x - 20);
					groupRect.setAttribute('y', typeLayout.y - 40);
					groupRect.setAttribute('width', typeLayout.width + 40);
					groupRect.setAttribute('height', typeLayout.height + componentCount * 25 + 50);
					groupRect.setAttribute('fill', '#f9fafb');
					groupRect.setAttribute('stroke', '#e5e7eb');
					groupRect.setAttribute('stroke-width', '1');
					groupRect.setAttribute('rx', '8');
					svg.appendChild(groupRect);

					// Type label
					const typeLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
					typeLabel.setAttribute('x', typeLayout.x + typeLayout.width / 2);
					typeLabel.setAttribute('y', typeLayout.y - 20);
					typeLabel.setAttribute('class', 'component-text component-label');
					typeLabel.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)}s (${components.length})`;
					svg.appendChild(typeLabel);

					// Draw individual components
					components.slice(0, 5).forEach((component, index) => {
						const y = typeLayout.y + index * 25;
						const status = getComponentStatus(component, recentInteractions);

						const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
						rect.setAttribute('x', typeLayout.x);
						rect.setAttribute('y', y);
						rect.setAttribute('width', typeLayout.width);
						rect.setAttribute('height', 20);
						rect.setAttribute('class', `component-node ${status}`);
						rect.setAttribute('rx', '4');
						svg.appendChild(rect);

						const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
						text.setAttribute('x', typeLayout.x + typeLayout.width / 2);
						text.setAttribute('y', y + 10);
						text.setAttribute('class', 'component-text');
						text.textContent = `...${component.componentId.slice(-8)}`;
						svg.appendChild(text);
					});

					if (components.length > 5) {
						const moreText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
						moreText.setAttribute('x', typeLayout.x + typeLayout.width / 2);
						moreText.setAttribute('y', typeLayout.y + 5 * 25 + 15);
						moreText.setAttribute('class', 'component-text component-stats');
						moreText.textContent = `+${components.length - 5} more`;
						svg.appendChild(moreText);
					}
				});

				// Draw connections
				const connections = [
					{ from: 'queue', to: 'publisher' },
					{ from: 'publisher', to: 'distributor' },
					{ from: 'distributor', to: 'subscriber' },
					{ from: 'publisher', to: 'subscriber' }, // Direct connection for fallback
				];

				connections.forEach(({ from, to }) => {
					if (componentTypes[from].length === 0 || componentTypes[to].length === 0) return;

					const fromLayout = layout[from];
					const toLayout = layout[to];
					const isActive = hasActiveFlow(from.charAt(0).toUpperCase() + from.slice(1), to.charAt(0).toUpperCase() + to.slice(1));

					const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
					const startX = fromLayout.x + fromLayout.width;
					const startY = fromLayout.y + fromLayout.height / 2;
					const endX = toLayout.x;
					const endY = toLayout.y + toLayout.height / 2;

					// Create curved path
					const midX = (startX + endX) / 2;
					const pathData = `M ${startX} ${startY} Q ${midX} ${startY < endY ? startY - 30 : startY + 30} ${endX} ${endY}`;

					path.setAttribute('d', pathData);
					path.setAttribute('class', `flow-connection ${isActive ? 'active' : ''}`);
					path.setAttribute('marker-end', isActive ? 'url(#arrowhead-active)' : 'url(#arrowhead)');
					svg.appendChild(path);
				});
			}

			async function generateTickerData() {
				try {
					const response = await fetch('/queue', { method: 'POST' });
					if (response.ok) {
						// Wait a moment for the data to propagate, then refresh
						setTimeout(() => {
							refreshFlowDiagram();
							refreshOverview();
							refreshInteractions();
							refreshComponents();
						}, 2000);

						// Show feedback
						const svg = document.getElementById('flow-svg');
						const feedbackText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
						feedbackText.setAttribute('x', 600);
						feedbackText.setAttribute('y', 50);
						feedbackText.setAttribute('class', 'component-text');
						feedbackText.setAttribute('text-anchor', 'middle');
						feedbackText.setAttribute('fill', '#059669');
						feedbackText.textContent = '‚úÖ Ticker data generated! Refreshing in 2 seconds...';
						svg.appendChild(feedbackText);

						setTimeout(() => {
							if (feedbackText.parentNode) {
								feedbackText.parentNode.removeChild(feedbackText);
							}
						}, 3000);
					}
				} catch (error) {
					console.error('Error generating ticker data:', error);
				}
			}
		</script>
	</body>
</html>
